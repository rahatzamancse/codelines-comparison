<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penguin Scatterplot - D3</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .tooltip {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 4px;
            pointer-events: none;
            font-size: 12px;
        }

        .legend {
            font-size: 12px;
        }

        .annotation-note-title {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h2>Penguin Scatterplot</h2>
    <div id="chart"></div>

    <script>
        // Set up dimensions and margins
        const margin = { top: 40, right: 100, bottom: 60, left: 70 };
        const width = 700 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;

        // Create SVG
        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Create tooltip
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Load data
        d3.json("data/penguins.json").then(data => {
            // Create scales
            const xScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d["Flipper Length (mm)"]))
                .range([0, width])
                .nice();

            const yScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d["Body Mass (g)"]))
                .range([height, 0])
                .nice();

            // Color scale for species
            const colorScale = d3.scaleOrdinal()
                .domain([...new Set(data.map(d => d.Species))])
                .range(d3.schemeCategory10);

            // Shape scale for species
            const shapeScale = d3.scaleOrdinal()
                .domain([...new Set(data.map(d => d.Species))])
                .range(d3.symbols.map(s => d3.symbol().type(s)()));

            // Add X axis
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale))
                .append("text")
                .attr("x", width / 2)
                .attr("y", 40)
                .attr("fill", "black")
                .style("text-anchor", "middle")
                .style("font-size", "14px")
                .text("Flipper Length (mm)");

            // Add Y axis
            svg.append("g")
                .call(d3.axisLeft(yScale))
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -50)
                .attr("x", -height / 2)
                .attr("fill", "black")
                .style("text-anchor", "middle")
                .style("font-size", "14px")
                .text("Body Mass (g)");

            // Add points
            svg.selectAll(".point")
                .data(data)
                .join("path")
                .attr("class", "point")
                .attr("transform", d => `translate(${xScale(d["Flipper Length (mm)"])},${yScale(d["Body Mass (g)"])})`)
                .attr("d", d => {
                    const symbolType = d3.symbols.find((_, i) =>
                        [...new Set(data.map(d => d.Species))].indexOf(d.Species) === i % d3.symbols.length);
                    return d3.symbol().type(symbolType).size(100)();
                })
                .attr("fill", d => colorScale(d.Species))
                .on("mouseover", function (event, d) {
                    d3.select(this)
                        .attr("stroke", "#000")
                        .attr("stroke-width", 2);

                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);

                    tooltip.html(`
                        <strong>Species:</strong> ${d.Species}<br>
                        <strong>Flipper Length:</strong> ${d["Flipper Length (mm)"]} mm<br>
                        <strong>Body Mass:</strong> ${d["Body Mass (g)"]} g
                    `)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function () {
                    d3.select(this)
                        .attr("stroke", "none");

                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add legend
            const legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(${width + 20}, 0)`);

            const species = [...new Set(data.map(d => d.Species))];

            species.forEach((species, i) => {
                const legendRow = legend.append("g")
                    .attr("transform", `translate(0, ${i * 20})`);

                // Symbol
                legendRow.append("path")
                    .attr("d", d => {
                        const symbolType = d3.symbols.find((_, idx) => i === idx % d3.symbols.length);
                        return d3.symbol().type(symbolType).size(100)();
                    })
                    .attr("fill", colorScale(species))
                    .attr("transform", "translate(0, 0)");

                // Text
                legendRow.append("text")
                    .attr("x", 15)
                    .attr("y", 5)
                    .text(species);
            });

            // Add Gentoo ellipse enclosure
            const gentooData = data.filter(d => d.Species === "Gentoo");

            // Calculate the center and dimensions of the ellipse
            const gentooX = gentooData.map(d => d["Flipper Length (mm)"]);
            const gentooY = gentooData.map(d => d["Body Mass (g)"]);

            const xMean = d3.mean(gentooX);
            const yMean = d3.mean(gentooY);

            // Calculate standard deviations and scale them for the ellipse size
            const xStd = d3.deviation(gentooX) * 2.5;
            const yStd = d3.deviation(gentooY) * 2.5;

            // Add the ellipse
            svg.append("ellipse")
                .attr("cx", xScale(xMean))
                .attr("cy", yScale(yMean))
                .attr("rx", xScale(xMean + xStd) - xScale(xMean))
                .attr("ry", yScale(yMean - yStd) - yScale(yMean))
                .attr("fill", colorScale("Gentoo"))
                .attr("opacity", 0.2)
                .attr("stroke", colorScale("Gentoo"))
                .attr("stroke-width", 2)
                .attr("stroke-dasharray", "5,5");

            // Define the outlier point
            const outlierX = 185;  // Approximate x-coordinate of outlier point
            const outlierY = 4700; // Approximate y-coordinate of outlier point

            // Create annotations array
            const annotations = [
                // Gentoo cluster annotation
                {
                    type: d3.annotationLabel,
                    note: {
                        title: "Gentoo Cluster",
                        padding: 5
                    },
                    x: xScale(xMean),
                    y: yScale(yMean - yStd) - 10,
                    dy: -10,
                    dx: 0,
                    color: colorScale("Gentoo")
                },

                // Outlier annotation
                {
                    type: d3.annotationCalloutElbow,
                    note: {
                        title: "Outlier!",
                        padding: 5
                    },
                    x: xScale(outlierX),
                    y: yScale(outlierY),
                    dx: 30,
                    dy: -30,
                    color: "blue",
                    connector: {
                        end: "arrow"
                    }
                }
            ];

            // Add annotation for Gentoo in the legend
            const gentooIndex = species.indexOf("Gentoo");
            if (gentooIndex !== -1) {
                // Find the position of the Gentoo text in the legend
                const gentooLegendX = width + 20 + 15; // legend x + text offset
                const gentooLegendY = gentooIndex * 20 + 5; // legend y for this row + text offset

                annotations.push({
                    type: d3.annotationLabel,
                    note: {
                        title: "G for Green",
                        padding: 5,
                        align: "middle",
                        orientation: "leftright"
                    },
                    x: gentooLegendX,
                    y: gentooLegendY + 15,
                    dx: 0,
                    dy: 0,
                    color: "green",
                    className: "legend-annotation"
                });
            }

            // Add annotations to the chart
            const makeAnnotations = d3.annotation()
                .annotations(annotations);

            svg.append("g")
                .attr("class", "annotation-group")
                .call(makeAnnotations);
        }).catch(error => {
            console.error("Error loading data:", error);
            d3.select("#chart").append("p")
                .text("Error loading data. Please check the console for details.");
        });
    </script>
</body>

</html>